<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.workus.attendance.mapper.AttendanceMapper">
    <select id="getAttendanceByUserNo" resultType="AttendanceDto">
        select
            U.USER_NO as no
            , U.ROLE_NO as roleNo
            , U.USER_UNUSED_ANNUAL_LEAVE as unusedAnnualLeave
            , P.ANNUAL_LEAVE_COUNT as annualLeaveCount
        from WORKUS_USERS U
           , WORKUS_POSITION P
        where U.POSITION_NO = P.POSITION_NO
          and U.User_NO = #{userNo}
    </select>
    <select id="getAllCategories" resultType="atdCategoryDto">
        select
            ATD_CATEGORY_NO as no
            , ATD_CATEGORY_NAME as name
            , ATD_CATEGORY_COUNT as count
        from
            WORKUS_ATTENDANCE_CATEGORY;
    </select>
    <insert id="insertApproval" >
        insert into
            WORKUS_ATTENDANCE
            (ATD_TEXT
            , ATD_FROM_DATE
            , ATD_TO_DATE
            , ATD_CATEGORY_NO
            , USER_NO
            , ATD_CATEGORY_TIME)
        values
            (#{form.reason}
            , #{form.fromDate}
            , #{form.toDate}
            , #{form.categoryNo}
            , #{form.userNo}
            , #{form.time})
        <selectKey keyProperty="form.no" resultType="Long" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
    </insert>
    <insert id="insertApprovalUsers" >
        insert into
        WORKUS_ATTENDANCE_USER
        (ATD_APPROVAL_STATUS
        , ATD_SEQUENCE
        , USER_NO
        , ATD_NO)
        values
        <foreach collection="users" item="user" separator=",">
            (#{user.status}
            , #{user.sequence}
            , #{user.userNo}
            , #{form.no})
        </foreach>
    </insert>
    <select id="getAllRequestFormsByUserNo" resultType="reqViewDto">
        SELECT DISTINCT
            A.ATD_NO AS no
            , U.ATD_STATUS AS status
            , A.ATD_TEXT AS reason
            , A.ATD_TO_DATE AS toDate
            , A.ATD_FROM_DATE AS fromDate
            , A.ATD_CREATED_DATE AS createdDate
            , A.ATD_CATEGORY_TIME AS time
            , C.ATD_CATEGORY_NAME AS categoryName
        FROM
        WORKUS_ATTENDANCE A
        JOIN
        WORKUS_ATTENDANCE_USER U ON A.ATD_NO = U.ATD_NO
        JOIN
        WORKUS_ATTENDANCE_CATEGORY C ON A.ATD_CATEGORY_NO = C.ATD_CATEGORY_NO
        WHERE
        A.USER_NO = #{userNo}
        <if test="condition.status != null">
            AND U.ATD_NO IN (
            SELECT U2.ATD_NO
            FROM WORKUS_ATTENDANCE_USER U2
            JOIN WORKUS_ATTENDANCE A2 ON U2.ATD_NO = A2.ATD_NO
            WHERE U2.ATD_STATUS = 'I'
            );
        </if>
    </select>
    <select id="getTotalRows" resultType="int">
        select
            count(*) as CNT
        from
            WORKUS_ATTENDANCE
        where
            USER_NO = #{userNo}
        <if test="condition.status != null">
            AND ATD_NO IN (SELECT U2.ATD_NO
            FROM WORKUS_ATTENDANCE_USER U2
            JOIN WORKUS_ATTENDANCE A2 ON U2.ATD_NO = A2.ATD_NO
            WHERE U2.ATD_STATUS = 'I')
        </if>
    </select>
    <select id="getAllReferenceFormsByUserNo" resultType="refViewDto">
        SELECT A.ATD_NO AS atdNo
               , U.ATD_APPROVAL_NO as refNo
               , U.ATD_STATUS AS status
               , A.ATD_TEXT AS reason
               , A.ATD_TO_DATE AS toDate
               , A.ATD_FROM_DATE AS fromDate
               , A.ATD_CREATED_DATE AS createdDate
               , A.ATD_CATEGORY_TIME AS time
               , C.ATD_CATEGORY_NAME AS categoryName
               , AU.USER_NAME AS reqUserName
        FROM
            WORKUS_ATTENDANCE A
            JOIN
            WORKUS_ATTENDANCE_USER U ON A.ATD_NO = U.ATD_NO
            JOIN
            WORKUS_ATTENDANCE_CATEGORY C ON A.ATD_CATEGORY_NO = C.ATD_CATEGORY_NO
            JOIN
            WORKUS_USERS AU ON A.USER_NO = AU.USER_NO
        WHERE
            U.USER_NO = #{userNo}
        AND U.ATD_APPROVAL_STATUS = 50
        <if test="condition.opt != null">
            <choose>
                <when test="condition.opt == 'name'">
                    and AU.USER_NAME like CONCAT('%', #{condition.keyword}, '%')
                </when>
                <when test="condition.opt == 'reason'">
                    and A.ATD_TEXT like CONCAT('%', #{condition.keyword}, '%')
                </when>
            </choose>
        </if>
    </select>
    <select id="getAllApprovalFormsByUserNo" resultType="apvViewDto">
        SELECT A.ATD_NO AS atdNo
        , U.ATD_APPROVAL_NO as apvNo
        , U.ATD_STATUS AS status
        , A.ATD_TEXT AS reason
        , A.ATD_TO_DATE AS toDate
        , A.ATD_FROM_DATE AS fromDate
        , A.ATD_CREATED_DATE AS createdDate
        , A.ATD_CATEGORY_TIME AS time
        , C.ATD_CATEGORY_NAME AS categoryName
        , AU.USER_NAME AS reqUserName
        FROM
        WORKUS_ATTENDANCE A
        JOIN
        WORKUS_ATTENDANCE_USER U ON A.ATD_NO = U.ATD_NO
        JOIN
        WORKUS_ATTENDANCE_CATEGORY C ON A.ATD_CATEGORY_NO = C.ATD_CATEGORY_NO
        JOIN
        WORKUS_USERS AU ON A.USER_NO = AU.USER_NO
        WHERE
        U.USER_NO = #{userNo}
        AND U.ATD_APPROVAL_STATUS = 49
        <if test="condition.opt != null">
            <choose>
                <when test="condition.opt == 'name'">
                    and AU.USER_NAME like CONCAT('%', #{condition.keyword}, '%')
                </when>
                <when test="condition.opt == 'reason'">
                    and A.ATD_TEXT like CONCAT('%', #{condition.keyword}, '%')
                </when>
            </choose>
        </if>
    </select>
</mapper>